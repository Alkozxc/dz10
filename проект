from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, ContextTypes, filters
import urllib.parse
import requests

TOKEN = "8015046189:AAHCrM2Lagedg4fCA0T7rAdMIAr53nTTyG4"

LANGS = {
    "–†—É—Å—Å–∫–∏–π": "ru",
    "English": "en",
    "Deutsch": "de",
    "Fran√ßais": "fr",
    "Espa√±ol": "es"
}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    keyboard = [[InlineKeyboardButton(k, callback_data=f"from_{v}")] for k, v in LANGS.items()]
    await update.message.reply_text("–° –∫–∞–∫–æ–≥–æ —è–∑—ã–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º?", reply_markup=InlineKeyboardMarkup(keyboard))

async def from_lang(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    context.user_data["from"] = q.data[5:]
    keyboard = [[InlineKeyboardButton(k, callback_data=f"to_{v}")] for k, v in LANGS.items()]
    await q.edit_message_text("–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫?", reply_markup=InlineKeyboardMarkup(keyboard))

async def to_lang(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    context.user_data["to"] = q.data[3:]
    await q.edit_message_text("–û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞")

async def translate(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    sl = context.user_data["from"]
    tl = context.user_data["to"]

    url = "https://translate.googleapis.com/translate_a/single"

    params = {
        "client": "gtx",
        "sl": sl,
        "tl": tl,
        "dt": "t",
        "q": text
    }

    try:
        r = requests.get(url, params=params, timeout=20)
        data = r.json()
        result = "".join([item[0] for item in data[0]])
        await update.message.reply_text(result)
    except Exception as e:
        print(e)
        await update.message.reply_text("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞")

async def stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "–ü–µ—Ä–µ–≤–æ–¥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω üõë\n"
        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤—å /start"
    )

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(from_lang, pattern="^from_"))
app.add_handler(CallbackQueryHandler(to_lang, pattern="^to_"))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, translate))
app.add_handler(CommandHandler("stop", stop))


print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
app.run_polling()
